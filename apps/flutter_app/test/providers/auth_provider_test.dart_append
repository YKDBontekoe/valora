    test('refreshSession should log severe and keep state on unexpected failure', () async {
      final header = base64Url.encode(
        utf8.encode(json.encode({'typ': 'JWT', 'alg': 'HS256'})),
      );
      final payload = base64Url.encode(
        utf8.encode(json.encode({'email': 'unexpected@example.com'})),
      );
      final token = '$header.$payload.signature';

      when(mockAuthService.getToken()).thenAnswer((_) async => token);
      await authProvider.checkAuth();

      when(
        mockAuthService.refreshToken(),
      ).thenThrow(Exception('Unexpected error'));

      final result = await authProvider.refreshSession();

      expect(result, isNull);
      expect(authProvider.isAuthenticated, true);
      expect(authProvider.email, 'unexpected@example.com');
      verifyNever(mockAuthService.deleteToken());
    });
  });
}
