name: Repost CodeRabbit Comments

on:
  issue_comment:
    types: [created]

jobs:
  repost-coderabbit:
    runs-on: ubuntu-latest
    if: github.event.comment.user.login == 'coderabbitai'
    steps:
      - name: Repost Comment
        uses: actions/github-script@v8
        env:
          VALORA_BOT_PAT: ${{ secrets.VALORA_BOT_PAT }}
        with:
          script: |
            const commentBody = context.payload.comment.body;

            // Regex to find the specific "Fix all issues with AI agents" section
            // We look for the summary tag containing the text, and capture everything until the closing details tag.
            const regex = /<details>\s*<summary>.*?Fix all issues with AI agents.*?<\/summary>([\s\S]*?)<\/details>/i;
            const match = commentBody.match(regex);

            if (match && match[1]) {
              const contentToRepost = match[1].trim();

              if (!contentToRepost) {
                console.log('Found the section but it was empty.');
                return;
              }

              console.log('Found "Fix all issues with AI agents" section. Reposting...');

              // We need to use the PAT to post as the user, not the github-actions bot.
              // If the secret is missing, we log a warning but cannot proceed with the specific requirement.
              const token = process.env.VALORA_BOT_PAT;
              if (!token) {
                console.log('::error::VALORA_BOT_PAT secret is missing. Cannot repost comment as user.');
                return;
              }

              // Initialize a new octokit instance with the PAT
              const github = require('@actions/github');
              const octokit = github.getOctokit(token);

              await octokit.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `**Reposted from CodeRabbit for Jules:**\n\n${contentToRepost}`
              });

            } else {
              console.log('Did not find "Fix all issues with AI agents" section in this CodeRabbit comment.');
            }
