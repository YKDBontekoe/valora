name: Deploy Backend to Azure Container App

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types: [completed]
    branches: [main]

concurrency:
  group: deploy-aca
  cancel-in-progress: false # Never cancel an in-progress deployment

jobs:
  deploy:
    name: Deploy to ACA
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 10
    environment: production
    env:
      # Must match the SENTRY_RELEASE set in the docker workflow (same SHA)
      SENTRY_RELEASE: ${{ github.event.workflow_run.head_sha }}
    steps:
      - name: Log in to Azure
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Lowercase repository name
        run: |
          echo "REPO=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Update Azure Container App
        uses: azure/cli@9f7ce6f37c31b777ec6c6b6d1dfe7db79f497956 # v2
        with:
          azcliversion: latest
          inlineScript: |
            az containerapp update \
              --name valora-backend \
              --resource-group rg-valora \
              --image ghcr.io/${{ env.REPO }}:sha-${{ github.event.workflow_run.head_sha }}

      - name: Verify deployment health
        run: |
          echo "â³ Waiting for deployment to stabilise..."
          sleep 30

          FQDN=$(az containerapp show \
            --name valora-backend \
            --resource-group rg-valora \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          echo "ğŸ” Health-checking https://$FQDN/api/health"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$FQDN/api/health" --max-time 15 || true)

          if [[ "$STATUS" == "200" ]]; then
            echo "âœ… Deployment healthy (HTTP $STATUS)"
          else
            echo "âš ï¸ Health check returned HTTP $STATUS â€” investigate manually."
            exit 1
          fi

      # â”€â”€ Finalise Sentry Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Mark the release as deployed to production *after* the health check
      # passes. This tells Sentry the exact moment production went live.
      - name: Finalise Sentry release
        uses: getsentry/action-release@dab6548b3c03c4717878099e43782cf5be654289 # v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT_BACKEND }}
        with:
          environment: production
          version: ${{ env.SENTRY_RELEASE }}
          finalize: true
          # Don't re-associate commits â€” already done in the docker workflow
          set_commits: skip
