name: Deploy Backend to Azure Container App

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types: [completed]
    branches: [main]

concurrency:
  group: deploy-aca
  cancel-in-progress: false # Never cancel an in-progress deployment

jobs:
  deploy:
    name: Deploy to ACA
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 10
    environment: production
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Lowercase repository name
        run: |
          echo "REPO=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Update Azure Container App
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az containerapp update \
              --name valora-backend \
              --resource-group rg-valora \
              --image ghcr.io/${{ env.REPO }}:sha-${{ github.event.workflow_run.head_sha }}

      - name: Verify deployment health
        run: |
          echo "‚è≥ Waiting for deployment to stabilise..."
          sleep 30

          FQDN=$(az containerapp show \
            --name valora-backend \
            --resource-group rg-valora \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          echo "üîç Health-checking https://$FQDN/api/health"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$FQDN/api/health" --max-time 15 || true)

          if [[ "$STATUS" == "200" ]]; then
            echo "‚úÖ Deployment healthy (HTTP $STATUS)"
          else
            echo "‚ö†Ô∏è Health check returned HTTP $STATUS ‚Äî investigate manually."
            exit 1
          fi
